name: Deploy to hosting (FTP)


on:
  push:
    branches: ["main"]


concurrency:
  group: deploy-ftp
  cancel-in-progress: true


jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp


      - name: Deploy via FTP (mirror + delete)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
        run: |
          set -euo pipefail


          if [ -z "${FTP_HOST:-}" ] || [ -z "${FTP_USER:-}" ] || [ -z "${FTP_PASS:-}" ] || [ -z "${FTP_PATH:-}" ]; then
            echo "ERROR: Missing required secrets. Need: FTP_HOST, FTP_USER, FTP_PASS, FTP_PATH (FTP_PORT optional)."
            exit 2
          fi


          PORT="${FTP_PORT:-21}"


          echo "Deploy target: ftp://${FTP_HOST}:${PORT}${FTP_PATH}"


          lftp -u "${FTP_USER}","${FTP_PASS}" -p "${PORT}" "${FTP_HOST}" <<EOF
          set ftp:ssl-allow no
          set ftp:passive-mode on
          set net:max-retries 2
          set net:timeout 20
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes


          # upload from repo root to FTP_PATH
          mirror -R --delete --verbose \
            --exclude-glob .git* \
            --exclude-glob .github* \
            --exclude-glob README_DEPLOY.md \
            ./ "${FTP_PATH}"


          bye
EOF
