name: Deploy to hosting (FTP)


on:
  push:
    branches: ["main"]


concurrency:
  group: deploy-ftp
  cancel-in-progress: true


jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp


      - name: Deploy via FTP (mirror + delete)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
        run: |
          set -euo pipefail


          if [ -z "${FTP_HOST:-}" ] || [ -z "${FTP_USER:-}" ] || [ -z "${FTP_PASS:-}" ]; then
            echo "ERROR: Missing required secrets. Need: FTP_HOST, FTP_USER, FTP_PASS (FTP_PORT optional, FTP_PATH optional)."
            exit 2
          fi


          PORT="${FTP_PORT:-21}"

          add_candidate () {
            local v="${1:-}"
            if [ -z "$v" ]; then return 0; fi
            for x in "${CANDIDATES[@]:-}"; do
              if [ "$x" = "$v" ]; then return 0; fi
            done
            CANDIDATES+=("$v")
          }

          CANDIDATES=()
          # Prefer FTP root first (common on ISPmanager chroot accounts)
          add_candidate "."
          add_candidate "/"

          # Common site-root patterns
          add_candidate "www/davis.ru"
          add_candidate "/www/davis.ru"
          add_candidate "davis.ru"
          add_candidate "/davis.ru"

          # User-provided path last (can point to nested folder on chrooted FTP)
          add_candidate "${FTP_PATH:-}"
          add_candidate "${FTP_PATH#/}"

          echo "Probing FTP target directories (to avoid wrong --delete)."
          BEST_DIR=""
          BEST_SCORE=0
          for d in "${CANDIDATES[@]}"; do
            echo "--- probe: ${d}"
            # probe listing; do NOT fail whole job on a bad candidate
            out="$(
              lftp -u "${FTP_USER}","${FTP_PASS}" -p "${PORT}" "${FTP_HOST}" <<EOF
              set ftp:ssl-allow no
              set ftp:passive-mode on
              set net:max-retries 2
              set net:timeout 20
              set net:reconnect-interval-base 5
              set cmd:fail-exit yes
              cd "${d}"
              pwd
              cls -1
              bye
          EOF
            )" || continue

            echo "$out"

            have_index=0
            have_assets=0
            while IFS= read -r line; do
              if [ "$line" = "index.html" ]; then have_index=1; fi
              if [ "${line%/}" = "assets" ]; then have_assets=1; fi
            done <<< "$out"

            score=0
            if [ "$have_index" -eq 1 ]; then score=1; fi
            if [ "$have_index" -eq 1 ] && [ "$have_assets" -eq 1 ]; then score=2; fi

            echo "probe score: ${score}"

            if [ "${score}" -gt "${BEST_SCORE}" ]; then
              BEST_SCORE="${score}"
              BEST_DIR="${d}"
            fi

            if [ "${BEST_SCORE}" -ge 2 ]; then
              break
            fi
          done

          if [ "${BEST_SCORE}" -le 0 ] || [ -z "${BEST_DIR:-}" ]; then
            echo "ERROR: Could not locate site root on FTP (no candidate contained index.html)."
            echo "Fix: set GitHub Secret FTP_PATH to the correct folder (e.g. '/', '.', 'www/davis.ru', or '/www/davis.ru') and re-run."
            exit 3
          fi

          echo "Using FTP target dir: ${BEST_DIR} (score=${BEST_SCORE})"
          echo "Deploy target: ftp://${FTP_HOST}:${PORT}${BEST_DIR}"

          lftp -u "${FTP_USER}","${FTP_PASS}" -p "${PORT}" "${FTP_HOST}" <<EOF
          set ftp:ssl-allow no
          set ftp:passive-mode on
          set net:max-retries 2
          set net:timeout 20
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes

          cd "${BEST_DIR}"
          pwd
          ls

          mirror -R --delete --verbose \
            --exclude-glob .git* \
            --exclude-glob .github* \
            --exclude-glob README_DEPLOY.md \
            ./ .

          bye
          EOF
