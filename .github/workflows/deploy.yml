name: Deploy to hosting (FTP)


on:
  push:
    branches: ["main"]


concurrency:
  group: deploy-ftp
  cancel-in-progress: true


jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp


      - name: Deploy via FTP (mirror + delete)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_PATH: ${{ secrets.FTP_PATH }}
        run: |
          set -euo pipefail


          if [ -z "${FTP_HOST:-}" ] || [ -z "${FTP_USER:-}" ] || [ -z "${FTP_PASS:-}" ]; then
            echo "ERROR: Missing required secrets. Need: FTP_HOST, FTP_USER, FTP_PASS (FTP_PORT optional, FTP_PATH optional)."
            exit 2
          fi


          PORT="${FTP_PORT:-21}"

          add_candidate () {
            local v="${1:-}"
            if [ -z "$v" ]; then return 0; fi
            for x in "${CANDIDATES[@]:-}"; do
              if [ "$x" = "$v" ]; then return 0; fi
            done
            CANDIDATES+=("$v")
          }

          CANDIDATES=()
          # Prefer FTP root first (common on ISPmanager chroot accounts)
          add_candidate "."
          add_candidate "/"

          # Common site-root patterns
          add_candidate "www/davis.ru"
          add_candidate "/www/davis.ru"
          add_candidate "davis.ru"
          add_candidate "/davis.ru"

          # User-provided path last (can point to nested folder on chrooted FTP)
          add_candidate "${FTP_PATH:-}"
          add_candidate "${FTP_PATH#/}"

          echo "Probing FTP target directories (to avoid wrong --delete)."
          FOUND_DIR=""
          for d in "${CANDIDATES[@]}"; do
            echo "--- probe: ${d}"
            # probe listing; do NOT fail whole job on a bad candidate
            out="$(
              lftp -u "${FTP_USER}","${FTP_PASS}" -p "${PORT}" "${FTP_HOST}" <<EOF
              set ftp:ssl-allow no
              set ftp:passive-mode on
              set net:max-retries 2
              set net:timeout 20
              set net:reconnect-interval-base 5
              set cmd:fail-exit yes
              cd "${d}"
              pwd
              cls -1
              bye
EOF
            )" || continue

            # Heuristic: правильная папка обычно содержит index.html и assets/
            python3 - <<'PY' "$out" && FOUND_DIR="$d" && break
import sys
txt = sys.argv[1]
lines = [l.strip() for l in txt.splitlines() if l.strip()]
have_index = any(l == "index.html" for l in lines)
have_assets = any(l.rstrip("/") == "assets" for l in lines)
sys.exit(0 if (have_index and have_assets) else 1)
PY
          done

          if [ -z "${FOUND_DIR:-}" ]; then
            echo "ERROR: Could not locate site root on FTP (no candidate contained both index.html and assets/)."
            echo "Fix: set GitHub Secret FTP_PATH to the correct folder (e.g. '/', '.', 'www/davis.ru', or '/www/davis.ru') and re-run."
            exit 3
          fi

          echo "Using FTP target dir: ${FOUND_DIR}"
          echo "Deploy target: ftp://${FTP_HOST}:${PORT}${FOUND_DIR}"

          lftp -u "${FTP_USER}","${FTP_PASS}" -p "${PORT}" "${FTP_HOST}" <<EOF
          set ftp:ssl-allow no
          set ftp:passive-mode on
          set net:max-retries 2
          set net:timeout 20
          set net:reconnect-interval-base 5
          set cmd:fail-exit yes

          cd "${FOUND_DIR}"
          pwd
          ls

          mirror -R --delete --verbose \
            --exclude-glob .git* \
            --exclude-glob .github* \
            --exclude-glob README_DEPLOY.md \
            ./ .

          bye
EOF
